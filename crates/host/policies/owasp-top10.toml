# OWASP Top 10 Audit Policy Pack
# ===========================================================================
# Covers the OWASP Top 10 2025:
# A01 Broken Access Control, A02 Security Misconfiguration, A03 Software Supply Chain Failures,
# A04 Cryptographic Failures, A05 Injection, A06 Insecure Design,
# A07 Authentication Failures, A08 Software or Data Integrity Failures, A09 Security Logging and Alerting Failures,
# A10 Mishandling of Exceptional Conditions.
# ===========================================================================

name    = "OWASP Top 10 Security Audit"
goal    = "Audit the target application and infrastructure against the OWASP Top 10 2025: broken access control, security misconfiguration, software supply chain failures, cryptographic failures, injection flaws, and authentication failures."
max_steps = 45

allowed_actions   = ["run_command", "read_file", "http_get", "complete"]
forbidden_actions = ["write_file", "delete_file"]

required_checks = [
    "A01: Access control configuration reviewed (permissions, RBAC)",
    "A02: Security headers and default configuration hardening verified",
    "A03: Dependency inventory and known CVE status reviewed",
    "A04: Cryptographic configuration reviewed (TLS version, cipher suites, hashing)",
    "A05: Input validation and injection surface identified",
    "A06: Insecure design mitigations checked",
    "A07: Authentication mechanism and session management reviewed",
    "A09: Application logging completeness verified",
    "A10: Exceptional conditions and error handling checked"
]

# ===========================================================================
# Command rules
# ===========================================================================

[[command_rules]]
description = "Allow general inspection and common security scanners"
pattern     = "^(ls|cat|find|grep|curl|openssl|nmap|nikto|git|pip|npm|yarn|composer|mvn|gradle|trivy|snyk|semgrep|bandit|gosec)\\b"
action      = "allow"

[[command_rules]]
description = "Block active exploitation frameworks"
pattern     = "metasploit|msfconsole|sqlmap --dbs|hydra|john --crack"
action      = "deny"

[[command_rules]]
description = "Block destructive operations"
pattern     = "\\brm\\s+-rf\\b|\\bdd\\b|\\bshred\\b"
action      = "deny"

# ===========================================================================
# Observation rules: A04 Cryptographic Failures & A07 Auth Failures
# ===========================================================================

[[observation_rules]]
description = "Redact API keys and tokens in output"
pattern     = "(?i)(api[_-]?key|access[_-]?token|bearer|secret)\\s*[=:]\\s*[A-Za-z0-9_\\-\\.]{16,}"
action      = "redact"
sensitivity = "high"

[[observation_rules]]
description = "Redact passwords in config or env output"
pattern     = "(?i)password\\s*[=:]\\s*\\S+"
action      = "redact"
sensitivity = "high"

[[observation_rules]]
description = "Redact private key PEM blocks"
pattern     = "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"
action      = "redact"
sensitivity = "high"

[[observation_rules]]
description = "Flag weak hashing algorithms (A04)"
pattern     = "(?i)\\b(md5|sha1|des|rc4)\\b"
action      = "flag"
sensitivity = "medium"

[[observation_rules]]
description = "Flag missing security headers in HTTP responses (A02)"
pattern     = "(?i)(X-Frame-Options|Content-Security-Policy|Strict-Transport-Security).*missing"
action      = "flag"
sensitivity = "low"

[[observation_rules]]
description = "Flag known vulnerable dependency CVE mentions (A03)"
pattern     = "CVE-[0-9]{4}-[0-9]{4,}"
action      = "flag"
sensitivity = "medium"

# ===========================================================================
# Approval gates: SSRF & key reading
# ===========================================================================

[[approval_gates]]
description     = "HTTP calls to internal CIDR 10.x require approval (SSRF Prevention)"
trigger         = "action == 'http_get' && url_host_in_cidr('10.0.0.0/8')"
require_approval = true
timeout_seconds = 60
on_timeout      = "deny"

[[approval_gates]]
description     = "HTTP calls to internal CIDR 172.16.x require approval (SSRF Prevention)"
trigger         = "action == 'http_get' && url_host_in_cidr('172.16.0.0/12')"
require_approval = true
timeout_seconds = 60
on_timeout      = "deny"

[[approval_gates]]
description     = "Reading certificate/key files requires approval (A04)"
trigger         = "action == 'read_file' && path_extension_matches('(\\.pem|\\.key|\\.crt|\\.p12)')"
require_approval = true
timeout_seconds = 120
on_timeout      = "deny"

[[approval_gates]]
description     = "Nikto or SQLMap invocation requires approval (A05)"
trigger         = "action == 'run_command' && command_matches_regex('nikto|sqlmap')"
require_approval = true
timeout_seconds = 300
on_timeout      = "deny"