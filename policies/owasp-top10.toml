# OWASP Top 10 Audit Policy Pack
# ---------------------------------------------------------------------------
# Covers the OWASP Top 10 2021:
# A01 Broken Access Control, A02 Cryptographic Failures, A03 Injection,
# A04 Insecure Design, A05 Security Misconfiguration, A06 Vulnerable Components,
# A07 Auth Failures, A08 Software Integrity Failures, A09 Logging Failures,
# A10 SSRF.
# ---------------------------------------------------------------------------

name    = "OWASP Top 10 Security Audit"
goal    = "Audit the target application and infrastructure against the OWASP Top 10 2021: injection flaws, broken authentication, sensitive data exposure, security misconfiguration, vulnerable components, and SSRF."
max_steps = 45

allowed_actions   = ["run_command", "read_file", "http_get", "complete"]
forbidden_actions = ["write_file", "delete_file"]

required_checks = [
    "A01 — Access control configuration reviewed (permissions, RBAC)",
    "A02 — Cryptographic configuration reviewed (TLS version, cipher suites, hashing)",
    "A03 — Input validation and injection surface identified",
    "A05 — Security headers and default configuration hardening verified",
    "A06 — Dependency inventory and known CVE status reviewed",
    "A07 — Authentication mechanism and session management reviewed",
    "A09 — Application logging completeness verified",
    "A10 — SSRF mitigations checked (URL allowlists, metadata endpoint blocking)",
]

# ---------------------------------------------------------------------------
# Command rules
# ---------------------------------------------------------------------------

[[command_rules]]
description = "Allow general inspection and common security scanners"
pattern     = "^(ls|cat|find|grep|curl|openssl|nmap|nikto|git|pip|npm|yarn|composer|mvn|gradle|trivy|snyk|semgrep|bandit|gosec)\\b"
action      = "allow"

[[command_rules]]
description = "Block active exploitation frameworks"
pattern     = "metasploit|msfconsole|sqlmap --dbs|hydra|john --crack"
action      = "deny"

[[command_rules]]
description = "Block destructive operations"
pattern     = "\\brm\\s+-rf\\b|\\bdd\\b|\\bshred\\b"
action      = "deny"

# ---------------------------------------------------------------------------
# Observation rules — A02 Cryptographic Failures & A07 Auth Failures
# ---------------------------------------------------------------------------

[[observation_rules]]
description = "Redact API keys and tokens in output"
pattern     = "(?i)(api[_-]?key|access[_-]?token|bearer|secret)\\s*[=:]\\s*[A-Za-z0-9_\\-\\.]{16,}"
action      = "redact"
sensitivity = "high"

[[observation_rules]]
description = "Redact passwords in config or env output"
pattern     = "(?i)password\\s*[=:]\\s*\\S+"
action      = "redact"
sensitivity = "high"

[[observation_rules]]
description = "Redact private key PEM blocks"
pattern     = "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"
action      = "redact"
sensitivity = "high"

[[observation_rules]]
description = "Flag weak hashing algorithms (A02)"
pattern     = "(?i)\\b(md5|sha1|des|rc4)\\b"
action      = "flag"
sensitivity = "medium"

[[observation_rules]]
description = "Flag missing security headers in HTTP responses (A05)"
pattern     = "(?i)(X-Frame-Options|Content-Security-Policy|Strict-Transport-Security).*missing"
action      = "flag"
sensitivity = "low"

[[observation_rules]]
description = "Flag known vulnerable dependency CVE mentions (A06)"
pattern     = "CVE-[0-9]{4}-[0-9]{4,}"
action      = "flag"
sensitivity = "medium"

# ---------------------------------------------------------------------------
# Approval gates — A10 SSRF & key reading
# ---------------------------------------------------------------------------

[[approval_gates]]
description     = "HTTP calls to internal CIDR 10.x require approval (A10 SSRF)"
trigger         = "action == 'http_get' && url_host_in_cidr('10.0.0.0/8')"
require_approval = true
timeout_seconds = 60
on_timeout      = "deny"

[[approval_gates]]
description     = "HTTP calls to internal CIDR 172.16.x require approval (A10 SSRF)"
trigger         = "action == 'http_get' && url_host_in_cidr('172.16.0.0/12')"
require_approval = true
timeout_seconds = 60
on_timeout      = "deny"

[[approval_gates]]
description     = "Reading certificate/key files requires approval (A02)"
trigger         = "action == 'read_file' && path_extension_matches('(\\.pem|\\.key|\\.crt|\\.p12)')"
require_approval = true
timeout_seconds = 120
on_timeout      = "deny"

[[approval_gates]]
description     = "Nikto or SQLMap invocation requires approval (A03)"
trigger         = "action == 'run_command' && command_matches_regex('nikto|sqlmap')"
require_approval = true
timeout_seconds = 300
on_timeout      = "deny"
